#!/usr/bin/env bash

if [ -z "$1" ]; then
  echo "Please provide the namespace as the first argument"
  exit 1
else
    if ! kubectl get ns "$1" &> /dev/null; then
        echo "Namespace $1 does not exist"
        exit 1
    else
        nspace="$1"
    fi
fi

# second argument is the pod name
if [ -z "$2" ]; then
    echo "Please provide the pod name as the second argument"
    exit 1
else
    pod="$2"
fi

echo "Images in $nspace/$pod:"

# Update Trivy DB once at the start (with cache mount)
echo "ðŸ“¦ Updating vulnerability database..."
TRIVY_CACHE_DIR="${HOME}/.cache/trivy"
mkdir -p "$TRIVY_CACHE_DIR"
docker run --rm \
  -v "$TRIVY_CACHE_DIR:/root/.cache/" \
  aquasec/trivy:latest \
  image --download-db-only 2>/dev/null


for image in $(kubectl get pods -n "$nspace" "$pod" -ojsonpath='{range .spec.containers[*]}{.image}{"\n"}{end}'); do
    read -p "Scan $image? (y/n): " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # scan $image
        docker run --rm \
            -v "$TRIVY_CACHE_DIR:/root/.cache/" \
            aquasec/trivy:latest \
            image \
            --skip-db-update \
            --severity HIGH,CRITICAL \
            --format table \
            --quiet \
            --timeout 10m \
            "$image" 2>&1
    else
        echo -e "\nSkipping ${image}...\n"
    fi
done
